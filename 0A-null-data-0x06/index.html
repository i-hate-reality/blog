<!DOCTYPE html>
<html lang="en">

<head>
    <title>(null), data= [ 0x06 ] | I hate reality</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>
    <meta name="author" content="Waffle Lapkin">

    <meta name="theme-color" content="#EE72F1"><link rel="stylesheet" href="https://blog.ihatereality.space/style.css">
    <link rel="stylesheet" href="https://blog.ihatereality.space/color/pink.css">

    <link rel="stylesheet" href="https://blog.ihatereality.space/font-hack.css">

    <meta name="description" content="debugging lsusb">

    <meta property="og:description" content="debugging lsusb">
    <meta property="og:title" content="(null), data= [ 0x06 ] | I hate reality">
    <meta property="og:type" content="article">
    <meta property="og:url" content="https://blog.ihatereality.space/0A-null-data-0x06/">

    <meta property="og:image" content="https://blog.ihatereality.space/you_cant_escape_from_reality_450x450.png">


                <link rel="alternate" type="application/rss+xml" title="I hate reality RSS Feed" href="https://blog.ihatereality.space/rss.xml" />
                <link rel="alternate" type="application/atom+xml" title="I hate reality Atom Feed" href="https://blog.ihatereality.space/atom.xml" />
        <link rel="shortcut icon" type="image/png" href="/you_cant_escape_from_reality_128x128.png">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://blog.ihatereality.space" style="text-decoration: none;">
                    <div class="logo">
                      
                            I hate reality
                        
                    </div>
                </a>
            </div>
        </div>

        
    <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://blog.ihatereality.space/about">about</a></li>
            
                <li><a href="https://github.com/i-hate-reality/blog" target="_blank" rel="noopener noreferrer">source</a></li>
            </ul>
        </nav>
    
    

    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://blog.ihatereality.space/0A-null-data-0x06/">(null), data= [ 0x06 ]</a></h1>
    
        <div class="post-meta-inline">
            
    <span class="post-date">
            2025-04-13
        
    </span>

            
    <span class="post-read-time">
        :: 4 min read
    </span>


            <!-- TODO: rethink how tags look -->
            <br>
            
        <span class="post-tags-inline">
                <a class="post-tag" href="https://blog.ihatereality.space/tags/lowercase/">#lowercase</a> 
                <a class="post-tag" href="https://blog.ihatereality.space/tags/programming/">#programming</a> 
                <a class="post-tag" href="https://blog.ihatereality.space/tags/usb/">#usb</a></span>
    
        </div>
    


        <div class="post-content">
            <p>so, recently i‚Äôve been ‚Äúworking‚Äù a lot with usb. both as-in trying to make a usb device and as-in trying to make an existing usb device work. (let‚Äôs all pray that i‚Äôll write more about both of these projects later). and, well, this journey is one made of pain‚Ä¶</p>
<span id="continue-reading"></span>
<p>it‚Äôs hard to pinpoint the exact problem, but for some reason the intersection of ‚Äúusb‚Äù, ‚Äúlinux permission management‚Äù, ‚Äúnixos‚Äù, and some non-standard things is just so painful. the errors are entirely opaque, information online is sparse, problems are confusing, debugging tools non-existent or hard to find, [‚Ä¶].</p>
<p>today i successfully debugged one issue that turned out to be quite funny, let me share the story.</p>
<p>i‚Äôm mainly working with usb-hid devices (universal serial bus human interface devices devices), i.e. things like keyboards and mice ‚Äì peripherals. one thing that is very helpful when debugging issues with them is getting ‚Äúhid-descriptor‚Äù ‚Äì description of the device and what it says it‚Äôll communicate.</p>
<p>on paper <code>lsusb</code> should be able to list this information, buuuut‚Ä¶</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>: ~; lsusb -d 1d50:615e -v | rg &quot;HID Device Descriptor&quot; -A9
</span><span>Couldn&#39;t open device, some information will be missing
</span><span>        HID Device Descriptor:
</span><span>          bLength                 9
</span><span>          bDescriptorType        33
</span><span>          bcdHID               1.11
</span><span>          bCountryCode            0 Not supported
</span><span>          bNumDescriptors         1
</span><span>          bDescriptorType        34 (null)
</span><span>          wDescriptorLength     103
</span><span>          Report Descriptors:
</span><span>            ** UNAVAILABLE **
</span></code></pre>
<p>to be clear, report descriptors are the interesting part ‚Äì it describes what the peripheral reports to the host.</p>
<p>in this example it‚Äôs quite easy to notice the error, but when i tried it for the first time it was a lot harder to notice because the error was between lines that my brain filtered out:</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>: ~; lsusb -d 1d50:615e -v
</span><span>
</span><span>Bus 005 Device 013: ID 1d50:615e OpenMoko, Inc. Blank Slate
</span><span>Couldn&#39;t open device, some information will be missing
</span><span>Negotiated speed: Full Speed (12Mbps)
</span><span>Device Descriptor:
</span><span>  bLength                18
</span><span>...
</span></code></pre>
 


  

  
    
  


<div class="callout">
  <img 
    class="callout-icon"
    src="/twemoji/assets/svg/1f438.svg"
    alt="üê∏"
  />
  <div class="callout-body">
    <p>why is there a blank line at the start?..</p>

  </div>
</div>
<p>idk.</p>
<p>but either way, if it can‚Äôt open the device, trying to run it as root is usually a good idea:</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>: ~; sudo lsusb -d 1d50:615e -v | rg &quot;Report Descriptors&quot; -A1
</span><span>          Report Descriptors:
</span><span>            ** UNAVAILABLE **
</span></code></pre>
<p>that didn‚Äôt help ;-;</p>
<p>and honestly, this is where my debugging stopped at first. i couldn‚Äôt find anything explaining how to get report descriptors.</p>
<p>today i was trying to debug this issue <em>again</em> (i keep running into it!) and actually <em>was</em> able to find a <a href="https://www.slashdev.ca/2010/05/08/get-usb-report-descriptor-with-linux/">solution in the slashdev.ca blog</a>. i‚Äôm‚Ä¶ not sure how i missed it the last time‚Ä¶ whatever. i built a command based on the solution and‚Ä¶</p>
<pre data-lang="shell" style="background-color:#2b303b;color:#c0c5ce;" class="language-shell "><code class="language-shell" data-lang="shell"><span>: ~; echo -n &quot;5-1.1.4:1.0&quot; | sudo tee /sys/bus/usb/drivers/usbhid/unbind \
</span><span>         &amp;&amp; sudo lsusb -d 1d50:615e -v | rg &quot;Report Descriptor&quot; -A10 \
</span><span>         &amp;&amp; echo -n &quot;5-1.1.4:1.0&quot; | sudo tee /sys/bus/usb/drivers/usbhid/bind
</span><span>5-1.1.4:1.0          Report Descriptor: (length is 103)
</span><span>            Item(Global): Usage Page, data= [ 0x01 ] 1
</span><span>                            (null)
</span><span>            Item(Local ): (null), data= [ 0x06 ] 6
</span><span>                            (null)
</span><span>            Item(Main  ): (null), data= [ 0x01 ] 1
</span><span>                            Application
</span><span>            Item(Global): (null), data= [ 0x01 ] 1
</span><span>            Item(Global): Usage Page, data= [ 0x07 ] 7
</span><span>                            (null)
</span><span>            Item(Local ): (null), data= [ 0xe0 ] 224
</span><span>5-1.1.4:1.0‚èé   
</span></code></pre>
<p>so, multiple things:</p>
<ol>
<li>yaaay it works</li>
<li>unbinding and rebinding the device is annoying</li>
<li>why does it say <code>(null)</code> everywhere???</li>
</ol>
<p>somehow <code>lsusb</code>‚Äôs parser must be broken ig?‚Ä¶ but how and why‚Ä¶ googling <code>lsusb descriptor "(null)"</code> of course yielded nothing.</p>
<p>one suspicion i had is that it might be a nixpkgs packaging mistake somehow. i looked at the source and sure enough they have a <a href="https://github.com/NixOS/nixpkgs/blob/82f9b33efe8953dcbd930ac88e27632ba073c92f/pkgs/by-name/us/usbutils/fix-paths.patch">suspicious patch</a>:</p>
<pre data-lang="patch" style="background-color:#2b303b;color:#c0c5ce;" class="language-patch "><code class="language-patch" data-lang="patch"><span>diff --git a/lsusb.py b/lsusb.py
</span><span>index bbc4dbb..8af1b1f 100755
</span><span>--- a/lsusb.py
</span><span>+++ b/lsusb.py
</span><span>@@ -27,8 +27,7 @@ </span><span style="color:#8fa1b3;">showwakeup = False
</span><span> 
</span><span> prefix = &quot;/sys/bus/usb/devices/&quot;
</span><span> usbids = [
</span><span style="color:#bf616a;">-	&quot;/usr/share/hwdata/usb.ids&quot;,
</span><span style="color:#bf616a;">-	&quot;/usr/share/usb.ids&quot;,
</span><span style="color:#a3be8c;">+	&quot;@hwdata@/share/hwdata/usb.ids&quot;,
</span><span> ]
</span><span> cols = (&quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;)
</span></code></pre>
<p>i tried checking if the right path is in the <code>lsusb</code> binary, but had no success.</p>
 


  

  
    
  


<div class="callout">
  <img 
    class="callout-icon"
    src="/twemoji/assets/svg/1f438.svg"
    alt="üê∏"
  />
  <div class="callout-body">
    <p>as it turns out, <code>lsusb.py</code> is a completely separate program from <code>lsusb</code> (although maintained by the same folks). <code>lsusb.py</code> provides different info that is sometimes nice to know, although it‚Äôs unclear why <code>lsusb</code> can‚Äôt do the same or vice versa‚Ä¶</p>

  </div>
</div>
<p>i then also tried this on my friend‚Äôs laptop (where <code>lsusb</code> comes from arch packages) and it had a similar bug, which suggests that this <em>isn‚Äôt</em> packaging mistake.</p>
<p>i decided to look into <code>lsusb</code> <a href="https://github.com/gregkh/usbutils/blob/ff432498eb7aeb4fe33a27ddc89a0a43d7fe6fe1/lsusb.c">sources</a>, hoping that maybe i can just see the bug. <code>^Fhid</code> found <code>dump_report_desc</code>, which calls <code>names_reporttag(btag)</code> (this is the function that returns <code>(null)</code>), which is just a wrapper over <code>names_genericstrtable</code> which is</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#b48ead;">static const char </span><span>*</span><span style="color:#8fa1b3;">names_genericstrtable</span><span>(</span><span style="color:#b48ead;">const struct</span><span> genericstrtable *</span><span style="color:#bf616a;">t</span><span>,
</span><span>					 </span><span style="color:#b48ead;">unsigned int </span><span style="color:#bf616a;">idx</span><span>)
</span><span>{
</span><span>	</span><span style="color:#b48ead;">const struct</span><span> genericstrtable *h;
</span><span>
</span><span>	</span><span style="color:#b48ead;">for </span><span>(h = t; t-&gt;name; t++)
</span><span>		</span><span style="color:#b48ead;">if </span><span>(h-&gt;num == idx)
</span><span>			</span><span style="color:#b48ead;">return</span><span> h-&gt;name;
</span><span>	</span><span style="color:#b48ead;">return </span><span style="color:#d08770;">NULL</span><span>;
</span><span>}
</span></code></pre>
 


  

  
    
  


<div class="callout">
  <img 
    class="callout-icon"
    src="/twemoji/assets/svg/1f438.svg"
    alt="üê∏"
  />
  <div class="callout-body">
    <p>wait‚Ä¶</p>

  </div>
</div>
<p>yep. i immediately noticed something fishy ‚Äì the <code>for</code> loop assigns to <code>h</code>, but then uses <code>t</code> is the condition and post-iteration-thing, but then uses <code>h</code> in the body again.</p>
<p>it took me a bit of time to convince myself this is actually a bug, simply because i‚Äôm not very familiar with the c language. but sure enough this is a bug.</p>
<p>it‚Äôs basically iterating over <code>t</code>, but then using <code>h</code> for return condition. this means that this function always returns <code>null</code>, unless it is asked to find the first element of the table. <code>git blame</code> shows that this was introduced when switching from hash tables to arrays+linear lookups.</p>
<p>do i even need to say that this would be easily caught by any reasonable language? oh well.</p>
<p>after that, i fixed the bug, created a <a href="https://github.com/WaffleLapkin/nixos/commit/0cc4993866642dbf3388624e9e2a11ef7d0f056e">patched package</a> for my own usage and sent <a href="https://github.com/gregkh/usbutils/pull/228">a pr with the fix</a> to the upstream.</p>
<p>okbye.</p>
<p>postscriptum: i only found this while writing this post, but it turns out <code>usbhid-dump</code> (still from the same package as <code>lsusb</code>) can dump the descriptor without unbinding the device?‚Ä¶ (but it doesn‚Äôt pretty print it) (why can‚Äôt <code>lsusb</code> do the same?‚Ä¶)</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>: ~; sudo usbhid-dump -d 1d50:615e
</span><span>005:013:000:DESCRIPTOR         1744574422.718624
</span><span> 05 01 09 06 A1 01 85 01 05 07 19 E0 29 E7 15 00
</span><span> 25 01 75 01 95 08 81 02 05 07 75 08 95 01 81 03
</span><span> 05 07 15 00 25 01 19 00 29 67 75 01 95 68 81 02
</span><span> C0 05 0C 09 01 A1 01 85 02 05 0C 15 00 26 FF 0F
</span><span> 19 00 2A FF 0F 75 10 95 06 81 00 C0 06 50 FF 0A
</span><span> 56 4C A1 01 85 50 15 00 25 01 75 01 95 40 05 0A
</span><span> 19 00 29 3F 81 02 C0
</span></code></pre>

        </div>

        
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright copyright--user"><div class="copyright"><span>¬© 2021-2025 Waffle Lapkin</span><span class="copyright-theme"><span class="copyright-theme-sep">  :: </span>Theme is based on <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a></span><span class="copyright-theme-sep"> :: </span><a href="/rss.xml">rss</a></div><span class="copyright-theme-sep"> :: </span><a href="/atom.xml">atom</a></div>
            </div>
    </footer>
    

</div>
    <!-- Tracking via https://www.goatcounter.com/ -->
    <script data-goatcounter="https://ihr.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</body>

</html>
